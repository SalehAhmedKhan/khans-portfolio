<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRD Peak Quick Reference</title>

  <!-- favicon lives three directories up -->
  <link rel="icon" type="image/png" href="../../../favicon1.png">

  <!-- SheetJS for reading .xlsx in-browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.72);
      --accent:#60a5fa;
      --warn:#f59e0b;
    }
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#070a14,#0b1020);
      color:var(--text);
    }
    .wrap{ max-width:1160px; margin:0 auto; padding:22px; }
    h1{ margin:0 0 6px; font-size:22px; letter-spacing:.2px; }
    .sub{ color:var(--muted); margin:0 0 16px; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 420px 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      padding:14px;
      backdrop-filter: blur(10px);
    }

    .panel-title{
      display:flex; align-items:center; justify-content:space-between;
      margin:0 0 10px;
      gap:10px;
    }
    .panel-title h2{
      margin:0;
      font-size:14px;
      color:var(--muted);
      font-weight:750;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .pills{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px; border-radius:999px;
      background:rgba(0,0,0,.14);
      white-space:nowrap;
    }

    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }

    select, input{
      width:100%;
      padding:11px 40px 11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.14));
      color:var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      transition: border-color .15s ease;
      font-size:14px;
    }
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      cursor:pointer;
      background-image:
        linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.14)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath fill='rgba(232,238,252,0.75)' d='M5.3 7.7a1 1 0 0 1 1.4 0L10 11l3.3-3.3a1 1 0 1 1 1.4 1.4l-4 4a1 1 0 0 1-1.4 0l-4-4a1 1 0 0 1 0-1.4z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position: 0 0, right 12px center;
      background-size: auto, 18px 18px;
    }
    input{ padding-right:12px; }
    select:hover, input:hover{ border-color: rgba(96,165,250,.35); }
    select:focus, input:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px rgba(96,165,250,.10), inset 0 1px 0 rgba(255,255,255,.06);
    }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .canvas-wrap{ padding:10px; }
    canvas{
      width:100%;
      height:300px;
      display:block;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th, td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.10); }
    th{ text-align:left; color:var(--muted); font-weight:750; }
    tr:hover{ background:rgba(96,165,250,.08); }

    .refbar{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .refbar .left{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .refbar .left b{ color:var(--text); font-weight:800; }

    .warn{
      color:rgba(245,158,11,.95);
      font-size:12px;
      margin-top:10px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>XRD 2θ–ω Peak Toolkit</h1>
    <p class="sub">Interactive quick reference for XRD peaks (from Excel).</p>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <div class="card">
        <div class="panel-title">
          <h2>Database</h2>
          <div class="pills">
            <span class="pill" id="xrayPill">λ: —</span>
            <span class="pill" id="updatePill">Updated: —</span>
          </div>
        </div>

        <label for="dbSel">Data file</label>
        <select id="dbSel"></select>

        <div class="panel-title" style="margin-top:14px;">
          <h2>Selection</h2>
        </div>

        <label for="materialSel">Material</label>
        <select id="materialSel"></select>

        <label for="orientSel">Orientation</label>
        <select id="orientSel"></select>

        <label for="paperSel">Paper (DOI)</label>
        <select id="paperSel"></select>

        <div class="row" style="margin-top:12px;">
          <div>
            <label for="xmin">2θ min</label>
            <input id="xmin" type="number" step="0.1" value="10" />
          </div>
          <div>
            <label for="xmax">2θ max</label>
            <input id="xmax" type="number" step="0.1" value="100" />
          </div>
        </div>

        <div class="warn" id="loadWarn" style="display:none;"></div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="card">
        <div class="canvas-wrap">
          <canvas id="plot" width="1400" height="460"></canvas>
        </div>

        <div class="refbar">
          <div class="left">
            <b>Reference:</b> <span id="doiText">—</span>
          </div>
          <div id="doiLinkWrap"></div>
        </div>

        <table id="peakTable">
          <thead>
            <tr>
              <th>2θ (degrees)</th>
              <th>Miller indices (hkl)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

      </div>
    </div>
  </div>

<script>
/* ---------- fixed plot params ---------- */
const FIXED_SIGMA_DEG = 0.15;
const FIXED_POINTS    = 2000;

/* ---------- Excel files (you can add more later) ---------- */
const DB_FILES_ALL = [
  { id:"cu_ka", label:"Cu Kα (Excel)", file:"xrd_database.xlsx", default:true }
];

let DB_FILES = [];
let STORE = null; // normalized structure: { meta:{...}, materials:[{id,name, orientations:[{name, papers:[{doi,peaks}]}]}] }

const els = {
  dbSel:       document.getElementById('dbSel'),
  xrayPill:    document.getElementById('xrayPill'),
  updatePill:  document.getElementById('updatePill'),
  materialSel: document.getElementById('materialSel'),
  orientSel:   document.getElementById('orientSel'),
  paperSel:    document.getElementById('paperSel'),
  xmin:        document.getElementById('xmin'),
  xmax:        document.getElementById('xmax'),
  plot:        document.getElementById('plot'),
  tableBody:   document.querySelector('#peakTable tbody'),
  loadWarn:    document.getElementById('loadWarn'),
  doiText:     document.getElementById('doiText'),
  doiLinkWrap: document.getElementById('doiLinkWrap')
};

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function gaussian(x, mu, sigma){
  const t = (x - mu) / sigma;
  return Math.exp(-0.5 * t * t);
}

/* Peaks parser: "18.90 (-201), 38.40 (-402)" => [{twoTheta,hkl}, ...] */
function parsePeaksLine(line){
  const s = String(line || "").trim();
  if (!s) return [];
  const parts = s.split(",").map(p => p.trim()).filter(Boolean);
  const out = [];
  for (const p of parts){
    const numMatch = p.match(/[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?/);
    const twoTheta = numMatch ? Number(numMatch[0]) : NaN;
    const hklMatch = p.match(/\(([^)]+)\)/);
    const hkl = hklMatch ? `(${hklMatch[1].trim()})` : "";
    if (Number.isFinite(twoTheta)) out.push({ twoTheta, hkl });
  }
  return out;
}

function formatDatePretty(iso){
  if (!iso) return "—";
  const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return iso;
  const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
  const dt = new Date(Date.UTC(y, mo, d));
  return dt.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit", timeZone:"UTC" });
}

function setHeaderPills(){
  const meta = STORE?.meta || {};
  const label = meta.xray_label;
  const wl = meta.wavelength_angstrom;
  const upd = meta.db_last_updated;

  els.xrayPill.textContent = (wl && label) ? `λ: ${wl} Å (${label})`
    : (wl ? `λ: ${wl} Å` : `λ: —`);
  els.updatePill.textContent = `Updated: ${formatDatePretty(upd)}`;
}

function getMaterials(){ return STORE?.materials || []; }

function findMaterial(id){ return getMaterials().find(m => m.id === id) || null; }
function findOrientation(mat, name){ return (mat?.orientations || []).find(o => o.name === name) || null; }

function rebuildMaterialDropdown(){
  const mats = getMaterials();
  els.materialSel.innerHTML = mats.map(m => {
    const label = m.name ? m.name : m.id;
    return `<option value="${m.id}">${label}</option>`;
  }).join("");
}

function rebuildOrientationDropdown(){
  const mat = findMaterial(els.materialSel.value);
  const orients = (mat?.orientations || []).map(o => o.name);
  els.orientSel.innerHTML = orients.map(o => `<option value="${o}">${o}</option>`).join("");
}

function rebuildPaperDropdown(){
  const mat = findMaterial(els.materialSel.value);
  const orient = findOrientation(mat, els.orientSel.value);
  const papers = orient?.papers || [];

  els.paperSel.innerHTML = papers.map((p, idx) => {
    const tag = `Paper ${idx + 1}`;
    return `<option value="${idx}">${tag}</option>`;
  }).join("");

  if (papers.length) els.paperSel.value = "0";
}

function getActivePaper(){
  const mat = findMaterial(els.materialSel.value);
  const orient = findOrientation(mat, els.orientSel.value);
  const papers = orient?.papers || [];
  if (!papers.length) return null;

  const idx = clamp(Number(els.paperSel.value || 0) || 0, 0, papers.length - 1);
  return papers[idx];
}

function renderReference(){
  const p = getActivePaper();
  const doi = p?.doi || "";
  els.doiText.textContent = doi || "—";
  els.doiLinkWrap.innerHTML = doi ? `<a href="${doi}" target="_blank" rel="noopener">open</a>` : "";
}

function renderTableAndPlot(){
  const p = getActivePaper();
  const peaks = parsePeaksLine(p?.peaks || "").sort((a,b) => a.twoTheta - b.twoTheta);

  els.tableBody.innerHTML = "";
  for (const pk of peaks){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${Number(pk.twoTheta).toFixed(2)}</td><td>${pk.hkl || ""}</td>`;
    tr.addEventListener("mouseenter", () => drawPlot(peaks, pk.twoTheta));
    tr.addEventListener("mouseleave", () => drawPlot(peaks, null));
    els.tableBody.appendChild(tr);
  }
  drawPlot(peaks, null);
}

function drawPlot(peaks, highlightTwoTheta=null){
  const canvas = els.plot;
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  const xmin = parseFloat(els.xmin.value);
  const xmax = parseFloat(els.xmax.value);

  const sigma = FIXED_SIGMA_DEG;
  const N = FIXED_POINTS;

  const filtered = (peaks || [])
    .map(p => ({ mu: Number(p.twoTheta), amp: 1 }))
    .filter(p => Number.isFinite(p.mu) && p.mu >= xmin && p.mu <= xmax);

  const xs = new Float64Array(N);
  const ys = new Float64Array(N);

  for (let i=0; i<N; i++){
    const x = xmin + (xmax - xmin) * (i / (N - 1));
    xs[i] = x;
    let y = 0;
    for (const pk of filtered){
      const t = (x - pk.mu) / sigma;
      y += Math.exp(-0.5 * t * t);
    }
    ys[i] = y;
  }

  let ymax = 0;
  for (let i=0; i<N; i++) if (ys[i] > ymax) ymax = ys[i];
  ymax = ymax || 1;

  ctx.clearRect(0,0,W,H);

  const mL = 100, mR = 26, mT = 22, mB = 72;
  const pW = W - mL - mR;
  const pH = H - mT - mB;

  const xToPx = x => mL + (x - xmin) / (xmax - xmin) * pW;
  const yToPx = y => mT + (1 - (y / ymax)) * pH;

  // grid
  ctx.lineWidth = 1;
  for (let i=0; i<=6; i++){
    const y = mT + (pH * i / 6);
    ctx.strokeStyle = "rgba(255,255,255,0.07)";
    ctx.beginPath(); ctx.moveTo(mL, y); ctx.lineTo(mL + pW, y); ctx.stroke();
  }

  // axes
  ctx.strokeStyle = "rgba(255,255,255,0.22)";
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(mL, mT);
  ctx.lineTo(mL, mT + pH);
  ctx.lineTo(mL + pW, mT + pH);
  ctx.stroke();

  // ticks
  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.font = "18px system-ui, Segoe UI, Arial";
  const tickCount = 7;
  for (let t=0; t<=tickCount; t++){
    const x = xmin + (xmax - xmin) * (t / tickCount);
    const px = xToPx(x);
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.beginPath(); ctx.moveTo(px, mT); ctx.lineTo(px, mT + pH); ctx.stroke();
    const txt = x.toFixed(0);
    ctx.fillText(txt, px - (txt.length*5), mT + pH + 40);
  }

  // labels
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  ctx.font = "20px system-ui, Segoe UI, Arial";
  ctx.fillText("2θ (degrees)", mL + pW/2 - 62, H - 18);

  ctx.save();
  ctx.translate(28, mT + pH/2 + 62);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Intensity (arb. units)", 0, 0);
  ctx.restore();

  // curve
  ctx.strokeStyle = "rgba(96,165,250,0.95)";
  ctx.lineWidth = 2.4;
  ctx.beginPath();
  for (let i=0; i<N; i++){
    const px = xToPx(xs[i]);
    const py = yToPx(ys[i]);
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.stroke();

  // sticks
  ctx.strokeStyle = "rgba(255,255,255,0.42)";
  ctx.lineWidth = 1.2;
  for (const pk of filtered){
    const px = xToPx(pk.mu);
    ctx.beginPath();
    ctx.moveTo(px, mT + pH);
    ctx.lineTo(px, mT + pH - 30);
    ctx.stroke();
  }

  // highlight
  if (highlightTwoTheta != null){
    const px = xToPx(highlightTwoTheta);
    ctx.strokeStyle = "rgba(245,158,11,0.95)";
    ctx.lineWidth = 2.6;
    ctx.beginPath();
    ctx.moveTo(px, mT);
    ctx.lineTo(px, mT + pH);
    ctx.stroke();
  }
}

function rerenderAll(){
  if (!STORE) return;
  setHeaderPills();
  renderReference();
  renderTableAndPlot();
}

/* ---------- Excel read + normalization ---------- */
function sheetToJson(wb, sheetName){
  const ws = wb.Sheets[sheetName];
  if (!ws) return [];
  return XLSX.utils.sheet_to_json(ws, { defval:"" });
}

function readMeta(metaRows){
  // expects columns: key, value
  const meta = {};
  for (const r of metaRows){
    const k = String(r.key || "").trim();
    if (!k) continue;
    meta[k] = r.value;
  }
  // normalize numeric wavelength
  if (meta.wavelength_angstrom !== undefined){
    const n = Number(meta.wavelength_angstrom);
    meta.wavelength_angstrom = Number.isFinite(n) ? n : meta.wavelength_angstrom;
  }
  return meta;
}

function normalizeEntries(rows){
  // expects headers: material_id, material_name, orientation, doi, peaks
  const byMat = new Map();

  for (const r of rows){
    const id = String(r.material_id || "").trim();
    if (!id) continue;
    const name = String(r.material_name || "").trim();
    const orient = String(r.orientation || "").trim();
    const doi = String(r.doi || "").trim();
    const peaks = String(r.peaks || "").trim();

    if (!byMat.has(id)){
      byMat.set(id, { id, name: name || id, orientations: [] });
    } else if (name && !byMat.get(id).name){
      byMat.get(id).name = name;
    }

    const mat = byMat.get(id);

    let o = mat.orientations.find(x => x.name === orient);
    if (!o){
      o = { name: orient, papers: [] };
      mat.orientations.push(o);
    }
    o.papers.push({ doi, peaks });
  }

  // stable ordering
  const materials = Array.from(byMat.values()).sort((a,b)=> (a.name||a.id).localeCompare(b.name||b.id));
  for (const m of materials){
    m.orientations.sort((a,b)=>a.name.localeCompare(b.name));
  }
  return materials;
}

async function loadExcel(file){
  try{
    els.loadWarn.style.display = "none";
    els.loadWarn.textContent = "";

    const res = await fetch(`./${file}`, { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} loading ${file}`);

    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array" });

    const metaRows = sheetToJson(wb, "meta");
    const entryRows = sheetToJson(wb, "entries");

    const meta = readMeta(metaRows);
    const materials = normalizeEntries(entryRows);

    STORE = { meta, materials };

    // Populate dropdowns
    rebuildMaterialDropdown();

    const firstMat = els.materialSel.querySelector("option");
    if (firstMat) els.materialSel.value = firstMat.value;

    rebuildOrientationDropdown();
    const firstOri = els.orientSel.querySelector("option");
    if (firstOri) els.orientSel.value = firstOri.value;

    rebuildPaperDropdown();

    rerenderAll();
  } catch (e){
    console.error(e);
    els.loadWarn.style.display = "";
    els.loadWarn.textContent =
      `Failed to load "${file}". Make sure "xrd_database.xlsx" is in the same folder as this HTML, and open via GitHub Pages (not double-click).`;
  }
}

/* ---------- only show Excel options that exist ---------- */
async function fileExists(file){
  try{
    const head = await fetch(`./${file}`, { method:"HEAD", cache:"no-store" });
    return head.ok;
  } catch {
    try{
      const res = await fetch(`./${file}`, { method:"GET", cache:"no-store" });
      return res.ok;
    } catch {
      return false;
    }
  }
}

async function populateDbDropdown(){
  const checks = await Promise.all(DB_FILES_ALL.map(async d => ({...d, exists: await fileExists(d.file)})));
  DB_FILES = checks.filter(d => d.exists);

  if (!DB_FILES.length){
    els.dbSel.innerHTML = "";
    els.loadWarn.style.display = "";
    els.loadWarn.textContent =
      `No Excel database file found. Put "xrd_database.xlsx" next to this HTML file.`;
    return null;
  }

  els.dbSel.innerHTML = DB_FILES.map(d => `<option value="${d.id}">${d.label}</option>`).join("");
  const def = DB_FILES.find(d => d.default) || DB_FILES[0];
  els.dbSel.value = def.id;
  return def;
}

/* ---------- UI wiring ---------- */
function wireUI(){
  els.dbSel.addEventListener("change", async () => {
    const id = els.dbSel.value;
    const item = DB_FILES.find(d => d.id === id) || DB_FILES[0];
    if (item) await loadExcel(item.file);
  });

  els.materialSel.addEventListener("change", () => {
    rebuildOrientationDropdown();
    const first = els.orientSel.querySelector("option");
    if (first) els.orientSel.value = first.value;
    rebuildPaperDropdown();
    rerenderAll();
  });

  els.orientSel.addEventListener("change", () => {
    rebuildPaperDropdown();
    rerenderAll();
  });

  els.paperSel.addEventListener("change", () => rerenderAll());

  els.xmin.addEventListener("input", () => rerenderAll());
  els.xmax.addEventListener("input", () => rerenderAll());
}

async function init(){
  wireUI();
  const def = await populateDbDropdown();
  if (def) await loadExcel(def.file);
}
init();
</script>
</body>
</html>
