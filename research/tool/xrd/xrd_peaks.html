<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRD Peak Quick Reference</title>

  <!-- favicon lives three directories up -->
  <link rel="icon" type="image/png" href="../../../favicon1.png">

  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.72);
      --accent:#60a5fa;
      --warn:#f59e0b;
    }
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#070a14,#0b1020);
      color:var(--text);
    }
    .wrap{ max-width:1160px; margin:0 auto; padding:22px; }
    h1{ margin:0 0 6px; font-size:22px; letter-spacing:.2px; }
    .sub{ color:var(--muted); margin:0 0 16px; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 420px 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      padding:14px;
      backdrop-filter: blur(10px);
    }

    .panel-title{
      display:flex; align-items:center; justify-content:space-between;
      margin:0 0 10px;
      gap:10px;
    }
    .panel-title h2{
      margin:0;
      font-size:14px;
      color:var(--muted);
      font-weight:750;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .pills{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px; border-radius:999px;
      background:rgba(0,0,0,.14);
      white-space:nowrap;
    }

    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }

    /* cleaner dropdown/input */
    select, input{
      width:100%;
      padding:11px 40px 11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.14));
      color:var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      transition: border-color .15s ease;
      font-size:14px;
    }
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      cursor:pointer;
      background-image:
        linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.14)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath fill='rgba(232,238,252,0.75)' d='M5.3 7.7a1 1 0 0 1 1.4 0L10 11l3.3-3.3a1 1 0 1 1 1.4 1.4l-4 4a1 1 0 0 1-1.4 0l-4-4a1 1 0 0 1 0-1.4z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position: 0 0, right 12px center;
      background-size: auto, 18px 18px;
    }
    input{ padding-right:12px; }
    select:hover, input:hover{ border-color: rgba(96,165,250,.35); }
    select:focus, input:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px rgba(96,165,250,.10), inset 0 1px 0 rgba(255,255,255,.06);
    }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .canvas-wrap{ padding:10px; }
    canvas{
      width:100%;
      height:300px;
      display:block;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th, td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.10); }
    th{ text-align:left; color:var(--muted); font-weight:750; }
    tr:hover{ background:rgba(96,165,250,.08); }

    .refbar{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .refbar .left{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .refbar .left b{ color:var(--text); font-weight:800; }
    .warn{
      color:rgba(245,158,11,.95);
      font-size:12px;
      margin-top:10px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>XRD 2θ–ω Peak Toolkit</h1>
    <p class="sub">Interactive quick reference for XRD peaks (from JSON).</p>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <div class="card">
        <div class="panel-title">
          <h2>Database</h2>
          <div class="pills">
            <span class="pill" id="xrayPill">λ: —</span>
            <span class="pill" id="updatePill">Updated: —</span>
          </div>
        </div>

        <label for="sourceSel">X-ray source</label>
        <select id="sourceSel"></select>

        <div class="panel-title" style="margin-top:14px;">
          <h2>Selection</h2>
        </div>

        <label for="materialSel">Material (ID)</label>
        <select id="materialSel"></select>

        <label for="orientSel">Orientation</label>
        <select id="orientSel"></select>

        <div class="row" style="margin-top:12px;">
          <div>
            <label for="xmin">2θ min</label>
            <input id="xmin" type="number" step="0.1" value="10" />
          </div>
          <div>
            <label for="xmax">2θ max</label>
            <input id="xmax" type="number" step="0.1" value="100" />
          </div>
        </div>

        <div class="warn" id="loadWarn" style="display:none;"></div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="card">
        <div class="canvas-wrap">
          <canvas id="plot" width="1400" height="460"></canvas>
        </div>

        <div class="refbar">
          <div class="left">
            <b>Reference:</b> <span id="doiText">—</span>
          </div>
          <div id="doiLinkWrap"></div>
        </div>

        <table id="peakTable">
          <thead>
            <tr>
              <th>2θ (degrees)</th>
              <th>Miller indices (hkl)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

      </div>
    </div>
  </div>

<script>
/* ---------- fixed plot params (no user controls) ---------- */
const FIXED_SIGMA_DEG = 0.15;
const FIXED_POINTS    = 2000;

/* ---------- X-ray sources (each maps to a JSON file) ---------- */
const XRAY_SOURCES_ALL = [
  { id:"cu_ka", label:"Cu Kα", file:"xrd_peaks_cu_ka.json", default:true },
  { id:"co_ka", label:"Co Kα", file:"xrd_peaks_co_ka.json" },
  { id:"mo_ka", label:"Mo Kα", file:"xrd_peaks_mo_ka.json" },
  { id:"cr_ka", label:"Cr Kα", file:"xrd_peaks_cr_ka.json" },
  { id:"fe_ka", label:"Fe Kα", file:"xrd_peaks_fe_ka.json" },
  { id:"ag_ka", label:"Ag Kα", file:"xrd_peaks_ag_ka.json" }
];

let XRAY_SOURCES = [];
let DB = null;

const els = {
  sourceSel:   document.getElementById('sourceSel'),
  xrayPill:    document.getElementById('xrayPill'),
  updatePill:  document.getElementById('updatePill'),
  materialSel: document.getElementById('materialSel'),
  orientSel:   document.getElementById('orientSel'),
  xmin:        document.getElementById('xmin'),
  xmax:        document.getElementById('xmax'),
  plot:        document.getElementById('plot'),
  tableBody:   document.querySelector('#peakTable tbody'),
  loadWarn:    document.getElementById('loadWarn'),
  doiText:     document.getElementById('doiText'),
  doiLinkWrap: document.getElementById('doiLinkWrap')
};

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function gaussian(x, mu, sigma){
  const t = (x - mu) / sigma;
  return Math.exp(-0.5 * t * t);
}

/* Parses "18.90 (-201), 38.40 (-402)" => [{twoTheta,hkl}, ...] */
function parsePeaksLine(line){
  const s = String(line || "").trim();
  if (!s) return [];

  // split by commas
  const parts = s.split(",").map(p => p.trim()).filter(Boolean);
  const out = [];
  for (const p of parts){
    const numMatch = p.match(/[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?/);
    const twoTheta = numMatch ? Number(numMatch[0]) : NaN;

    const hklMatch = p.match(/\(([^)]+)\)/);
    const hkl = hklMatch ? `(${hklMatch[1].trim()})` : "";

    if (Number.isFinite(twoTheta)) out.push({ twoTheta, hkl });
  }
  return out;
}

function formatDatePretty(iso){
  if (!iso) return "—";
  const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return iso;
  const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
  const dt = new Date(Date.UTC(y, mo, d));
  return dt.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit", timeZone:"UTC" });
}

function setHeaderPills(){
  const label = DB?.xray_label;
  const wl = DB?.wavelength_angstrom;
  const upd = DB?.db_last_updated;

  els.xrayPill.textContent = (wl && label) ? `λ: ${wl} Å (${label})`
    : (wl ? `λ: ${wl} Å` : `λ: —`);

  els.updatePill.textContent = `Updated: ${formatDatePretty(upd)}`;
}

function getSelectedMaterialId(){
  return els.materialSel.value;
}

function getSelectedOrientation(){
  return els.orientSel.value;
}

/* Find the "best" entry for current selections */
function getActiveEntry(){
  const matId = getSelectedMaterialId();
  const orient = getSelectedOrientation();
  const list = DB?.materials || [];
  return list.find(e => e.id === matId && e.orientation === orient) || null;
}

function rebuildMaterialDropdown(){
  const list = DB?.materials || [];
  const ids = Array.from(new Set(list.map(e => e.id))).sort((a,b)=>a.localeCompare(b));
  els.materialSel.innerHTML = ids.map(id => `<option value="${id}">${id}</option>`).join("");
}

function rebuildOrientationDropdown(){
  const list = DB?.materials || [];
  const matId = getSelectedMaterialId();
  const orients = Array.from(new Set(list.filter(e => e.id === matId).map(e => e.orientation)))
    .sort((a,b)=>a.localeCompare(b));

  els.orientSel.innerHTML = orients.map(o => `<option value="${o}">${o}</option>`).join("");
}

function renderReference(entry){
  const doi = entry?.doi || "";
  if (!doi){
    els.doiText.textContent = "—";
    els.doiLinkWrap.innerHTML = "";
    return;
  }
  els.doiText.textContent = doi;
  els.doiLinkWrap.innerHTML = `<a href="${doi}" target="_blank" rel="noopener">open</a>`;
}

function renderTable(entry){
  const peaks = parsePeaksLine(entry?.peaks || "").sort((a,b)=>a.twoTheta - b.twoTheta);
  els.tableBody.innerHTML = "";

  for (const p of peaks){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${Number(p.twoTheta).toFixed(2)}</td>
      <td>${p.hkl || ""}</td>
    `;
    tr.addEventListener('mouseenter', () => drawPlot(peaks, p.twoTheta));
    tr.addEventListener('mouseleave', () => drawPlot(peaks, null));
    els.tableBody.appendChild(tr);
  }

  drawPlot(peaks, null);
}

function drawPlot(peaks, highlightTwoTheta=null){
  const canvas = els.plot;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const xmin = parseFloat(els.xmin.value);
  const xmax = parseFloat(els.xmax.value);

  const sigma = FIXED_SIGMA_DEG;
  const N = FIXED_POINTS;

  const filtered = (peaks || [])
    .map(p => ({ mu: Number(p.twoTheta), amp: 1 }))
    .filter(p => Number.isFinite(p.mu) && p.mu >= xmin && p.mu <= xmax);

  // Build x grid + summed Gaussian y (visual only)
  const xs = new Float64Array(N);
  const ys = new Float64Array(N);

  for (let i=0; i<N; i++){
    const x = xmin + (xmax - xmin) * (i / (N - 1));
    xs[i] = x;
    let y = 0;
    for (const pk of filtered) y += pk.amp * gaussian(x, pk.mu, sigma);
    ys[i] = y;
  }

  let ymax = 0;
  for (let i=0; i<N; i++) if (ys[i] > ymax) ymax = ys[i];
  ymax = ymax || 1;

  ctx.clearRect(0,0,W,H);

  const mL = 100, mR = 26, mT = 22, mB = 72;
  const pW = W - mL - mR;
  const pH = H - mT - mB;

  const xToPx = x => mL + (x - xmin) / (xmax - xmin) * pW;
  const yToPx = y => mT + (1 - (y / ymax)) * pH;

  // subtle grid
  ctx.lineWidth = 1;
  for (let i=0; i<=6; i++){
    const y = mT + (pH * i / 6);
    ctx.strokeStyle = "rgba(255,255,255,0.07)";
    ctx.beginPath();
    ctx.moveTo(mL, y);
    ctx.lineTo(mL + pW, y);
    ctx.stroke();
  }

  // axes
  ctx.strokeStyle = "rgba(255,255,255,0.22)";
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(mL, mT);
  ctx.lineTo(mL, mT + pH);
  ctx.lineTo(mL + pW, mT + pH);
  ctx.stroke();

  // x ticks + labels
  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.font = "18px system-ui, Segoe UI, Arial";
  const tickCount = 7;
  for (let t=0; t<=tickCount; t++){
    const x = xmin + (xmax - xmin) * (t / tickCount);
    const px = xToPx(x);

    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.beginPath();
    ctx.moveTo(px, mT);
    ctx.lineTo(px, mT + pH);
    ctx.stroke();

    const txt = x.toFixed(0);
    ctx.fillText(txt, px - (txt.length*5), mT + pH + 40);
  }

  // axis labels
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  ctx.font = "20px system-ui, Segoe UI, Arial";
  ctx.fillText("2θ (degrees)", mL + pW/2 - 62, H - 18);

  ctx.save();
  ctx.translate(28, mT + pH/2 + 62);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Intensity (arb. units)", 0, 0);
  ctx.restore();

  // curve
  ctx.strokeStyle = "rgba(96,165,250,0.95)";
  ctx.lineWidth = 2.4;
  ctx.beginPath();
  for (let i=0; i<N; i++){
    const px = xToPx(xs[i]);
    const py = yToPx(ys[i]);
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.stroke();

  // sticks
  ctx.strokeStyle = "rgba(255,255,255,0.42)";
  ctx.lineWidth = 1.2;
  for (const pk of filtered){
    const px = xToPx(pk.mu);
    ctx.beginPath();
    ctx.moveTo(px, mT + pH);
    ctx.lineTo(px, mT + pH - 30);
    ctx.stroke();
  }

  // highlight
  if (highlightTwoTheta != null){
    const px = xToPx(highlightTwoTheta);
    ctx.strokeStyle = "rgba(245,158,11,0.95)";
    ctx.lineWidth = 2.6;
    ctx.beginPath();
    ctx.moveTo(px, mT);
    ctx.lineTo(px, mT + pH);
    ctx.stroke();
  }
}

function rerenderAll(){
  if (!DB) return;

  setHeaderPills();

  const entry = getActiveEntry();
  renderReference(entry);
  renderTable(entry);
}

function wireUI(){
  els.materialSel.addEventListener("change", () => {
    rebuildOrientationDropdown();
    // set to first orientation for this material
    const first = els.orientSel.querySelector("option");
    if (first) els.orientSel.value = first.value;
    rerenderAll();
  });

  els.orientSel.addEventListener("change", () => rerenderAll());

  els.xmin.addEventListener("input", () => rerenderAll());
  els.xmax.addEventListener("input", () => rerenderAll());

  els.sourceSel.addEventListener("change", async () => {
    const srcId = els.sourceSel.value;
    const src = XRAY_SOURCES.find(s => s.id === srcId) || XRAY_SOURCES[0];
    await loadDB(src.file);
  });
}

async function fileExists(file){
  try{
    const head = await fetch(`./${file}`, { method: "HEAD", cache: "no-store" });
    return head.ok;
  } catch {
    try{
      const res = await fetch(`./${file}`, { method: "GET", cache: "no-store" });
      return res.ok;
    } catch {
      return false;
    }
  }
}

async function populateSourceDropdown(){
  const checks = await Promise.all(
    XRAY_SOURCES_ALL.map(async s => ({ ...s, exists: await fileExists(s.file) }))
  );
  XRAY_SOURCES = checks.filter(s => s.exists);

  if (!XRAY_SOURCES.length){
    els.sourceSel.innerHTML = "";
    els.loadWarn.style.display = "";
    els.loadWarn.textContent =
      `No X-ray source JSON files were found in this folder. Put at least one JSON (e.g., "xrd_peaks_cu_ka.json") next to this HTML.`;
    return null;
  }

  els.sourceSel.innerHTML = XRAY_SOURCES
    .map(s => `<option value="${s.id}">${s.label}</option>`)
    .join("");

  const def = XRAY_SOURCES.find(s => s.default) || XRAY_SOURCES[0];
  els.sourceSel.value = def.id;
  return def;
}

async function loadDB(filename){
  try{
    els.loadWarn.style.display = "none";
    els.loadWarn.textContent = "";

    const res = await fetch(`./${filename}`, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} loading ${filename}`);

    DB = await res.json();

    rebuildMaterialDropdown();

    // select first material + first orientation
    const firstMat = els.materialSel.querySelector("option");
    if (firstMat) els.materialSel.value = firstMat.value;

    rebuildOrientationDropdown();
    const firstOri = els.orientSel.querySelector("option");
    if (firstOri) els.orientSel.value = firstOri.value;

    rerenderAll();
  } catch (e){
    console.error(e);
    els.loadWarn.style.display = "";
    els.loadWarn.textContent =
      `Failed to load "${filename}". If you opened the HTML by double-clicking it, fetch() may be blocked. Run a local server (VS Code Live Server or "python -m http.server") and reload.`;
  }
}

async function init(){
  wireUI();
  const def = await populateSourceDropdown();
  if (def) await loadDB(def.file);
}
init();
</script>
</body>
</html>
