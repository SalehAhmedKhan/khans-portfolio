<!-- File: journal.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading…</title>

    <!-- FAVICON (STATIC) -->
    <link rel="icon" type="image/png" href="../../../favicon1.png">

    <style>
        :root {
            /* Dark theme variables (match mobility-bgo aesthetic) */
            --bg: #0b1020;
            --card-bg: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.14);
            --accent: #60a5fa;
            --accent-soft: rgba(96, 165, 250, 0.14);
            --text-main: #e5e7eb;
            --text-muted: rgba(229, 231, 235, 0.72);
            --shadow-soft: 0 6px 18px rgba(0, 0, 0, 0.35);
            --radius: 10px;

            /* Seeded gradient vars (computed from JSON title) */
            --rg1: rgba(255, 140, 80, 0.10);
            --rg2: rgba(120, 80, 255, 0.10);
            --lg1: #070a14;
            --lg2: #0b1228;
            --lg3: #070a14;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                         Roboto, Helvetica, Arial, sans-serif;

            background:
                radial-gradient(circle at 18% 22%, var(--rg1), transparent 42%),
                radial-gradient(circle at 82% 28%, var(--rg2), transparent 46%),
                linear-gradient(140deg, var(--lg1) 0%, var(--lg2) 55%, var(--lg3) 100%);
            background-attachment: fixed;

            color: var(--text-main);
        }

        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Page shell */
        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1.25rem 2.5rem;
        }

        header.page-header { margin-bottom: 1.5rem; }

        /* ===== TITLE AREA ===== */
        .topic-label {
            font-size: 0.75rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .topic-title {
            font-size: clamp(1.9rem, 3vw, 2.4rem);
            font-weight: 700;
            margin: 0 0 0.25rem;
        }

        .topic-subtitle {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        /* Back link under title */
        .back-link {
            display: inline-block;
            margin-top: 0.6rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--accent);
        }

        /* Layout */
        .layout {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        main { flex: 1.7; }
        aside.sidebar { flex: 0.9; }

        @media (max-width: 900px) {
            .layout { flex-direction: column; }
            aside.sidebar { order: -1; }
        }

        /* ===== UPDATE LOG ===== */
        .sidebar-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            padding: 1rem 1rem 0.75rem;
            border: 1px solid var(--border);
        }

        .sidebar-card h2 {
            font-size: 1rem;
            margin: 0 0 0.5rem;
        }

        .log-help {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .log-list { list-style: none; padding: 0; margin: 0; }

        .log-item {
            border-left: 2px solid var(--border);
            padding-left: 0.6rem;
            margin-bottom: 0.6rem;
        }

        .log-item.latest {
            border-left-color: var(--accent);
            background: var(--accent-soft);
            border-radius: 4px;
            padding: 0.45rem 0.55rem;
        }

        .log-date { font-size: 0.8rem; color: var(--text-muted); }
        .log-text { font-size: 0.85rem; }

        /* ===== PAPER LIST ===== */
        .section-header {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.15rem;
        }

        .section-header span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .paper-list {
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .paper-card {
            position: relative;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border);
            padding: 1rem 1rem;
            display: flex;
            gap: 1rem;
            align-items: stretch;
            transition: box-shadow 0.15s ease;
        }

        .paper-card:hover {
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45);
        }

        .paper-main { flex: 1; }

        .paper-top-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem 1rem;
            align-items: center;
            margin-bottom: 0.3rem;
        }

        .paper-date {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .paper-gist {
            margin: 0.15rem 0 0.2rem;
            font-size: 1.02rem;
            font-weight: 600;
        }

        .paper-title {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .paper-authors {
            margin-top: 0.25rem;
            font-size: 0.83rem;
            color: var(--text-muted);
        }

        .paper-affil {
            margin-top: 0.2rem;
            font-size: 0.83rem;
            color: var(--text-muted);
        }

        /* Journal page link at bottom */
        .paper-footer {
            margin-top: 0.7rem;
            font-size: 0.88rem;
        }

        .paper-footer a {
            color: var(--accent);
            font-weight: 600;
        }

        /* Tags right aligned */
        .paper-tags {
            min-width: 140px;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            align-items: flex-end;
            justify-content: center;
        }

        @media (max-width: 700px) {
            .paper-card { flex-direction: column; }
            .paper-tags { align-items: flex-start; }
        }

        .tag {
            display: inline-block;
            padding: 0.18rem 0.45rem;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .tag.method { background: #fef3c7; color: #92400e; }
        .tag.device { background: #ecfdf3; color: #166534; }
        .tag.year   { background: #f3e8ff; color: #6b21a8; }

        /* optional subtle tag styling for extra keywords */
        .tag.other  { background: var(--accent-soft); color: var(--accent); }
    </style>
</head>

<body>
<div class="page">

    <!-- ===== TOPIC TITLE AREA ===== -->
    <header class="page-header">
        <div class="topic-label">Research Topic</div>
        <h1 class="topic-title" id="page-title">Loading…</h1>
        <p class="topic-subtitle" id="page-subtitle">Loading…</p>

        <!-- Back link to research hub (STATIC) -->
        <a class="back-link" href="../hub-page.html">← Back to Research Home</a>
    </header>

    <div class="layout">

        <!-- ===== MAIN CONTENT: PAPERS ===== -->
        <main>
            <div class="section-header">
                <h2>Paper log</h2>
                <span>(older at the top → newer towards the bottom)</span>
            </div>

            <div class="paper-list" id="paper-list">
                <!-- injected -->
            </div>
        </main>

        <!-- ===== SIDEBAR ===== -->
        <aside class="sidebar">
            <div class="sidebar-card">
                <h2>Update log</h2>
                <p class="log-help">
                    Latest updates appear at top. Edit manually as you add more papers.
                </p>

                <ul class="log-list" id="log-list">
                    <!-- injected -->
                </ul>
            </div>
        </aside>

    </div>
</div>

<script>
/* ========== Seeded gradient from JSON title (keeps same aesthetic) ========== */
function hash32(str){
  let h = 0x811c9dc5; // FNV-1a
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 0x01000193);
  }
  return h >>> 0;
}

function mulberry32(seed){
  let t = seed >>> 0;
  return function(){
    t += 0x6D2B79F5;
    let x = Math.imul(t ^ (t >>> 15), 1 | t);
    x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
    return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
  };
}

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function rgba(r,g,b,a){ return `rgba(${r|0}, ${g|0}, ${b|0}, ${a})`; }
function hexFromRGB(r,g,b){
  const toHex = n => n.toString(16).padStart(2, "0");
  return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

function applySeededGradient(title){
  const seed = hash32(title || "Journal");
  const rand = mulberry32(seed);

  // Warm-ish / cool-ish radials (subtle)
  const r1 = clamp(120 + Math.floor(120 * rand()), 90, 240);
  const g1 = clamp(60  + Math.floor(120 * rand()), 50, 220);
  const b1 = clamp(60  + Math.floor(120 * rand()), 50, 220);

  const r2 = clamp(60  + Math.floor(140 * rand()), 50, 230);
  const g2 = clamp(60  + Math.floor(140 * rand()), 50, 230);
  const b2 = clamp(120 + Math.floor(140 * rand()), 90, 255);

  const a1 = 0.08 + rand() * 0.05;
  const a2 = 0.08 + rand() * 0.05;

  // Deep linear gradient anchors
  const base1 = { r: 6 + Math.floor(10 * rand()), g: 8 + Math.floor(12 * rand()), b: 16 + Math.floor(18 * rand()) };
  const base2 = { r: 8 + Math.floor(12 * rand()), g: 10 + Math.floor(14 * rand()), b: 26 + Math.floor(20 * rand()) };
  const base3 = { r: 6 + Math.floor(10 * rand()), g: 8 + Math.floor(12 * rand()), b: 16 + Math.floor(18 * rand()) };

  document.documentElement.style.setProperty("--rg1", rgba(r1,g1,b1,a1));
  document.documentElement.style.setProperty("--rg2", rgba(r2,g2,b2,a2));
  document.documentElement.style.setProperty("--lg1", hexFromRGB(base1.r, base1.g, base1.b));
  document.documentElement.style.setProperty("--lg2", hexFromRGB(base2.r, base2.g, base2.b));
  document.documentElement.style.setProperty("--lg3", hexFromRGB(base3.r, base3.g, base3.b));
}

/* ========== Renderer ========== */
function el(tag, className, text){
  const n = document.createElement(tag);
  if(className) n.className = className;
  if(text !== undefined && text !== null) n.textContent = text;
  return n;
}

function yearFromDate(iso){
  if(!iso) return "";
  const m = String(iso).match(/^(\d{4})/);
  return m ? m[1] : "";
}

function groupFromByline(byline){
  if(!byline) return "";
  const parts = String(byline).split("—");
  return (parts[1] || "").trim();
}

function classifyTag(text, idx){
  // Keep the same tag color logic as your example:
  // method, device, year are colored; extras are default accent-soft.
  if(idx === 0) return "method";
  if(idx === 1) return "device";
  return "other";
}

function renderPaperCard(p){
  const card = el("article", "paper-card");

  const main = el("div", "paper-main");

  const topRow = el("div", "paper-top-row");
  topRow.appendChild(el("span", "paper-date", p.publishedDate || ""));
  main.appendChild(topRow);

  main.appendChild(el("h3", "paper-gist", p.gist || ""));
  main.appendChild(el("p", "paper-title", p.title || ""));

  // authors line = byline + et al. (matches original style)
  const authors = el("p", "paper-authors");
  authors.innerHTML = `${(p.byline || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")} <em>et al.</em>`;
  main.appendChild(authors);

  if(p.affiliation){
    main.appendChild(el("p", "paper-affil", p.affiliation));
  }

  // Link at bottom
  const footer = el("div", "paper-footer");
  const a = document.createElement("a");
  a.href = p.link || "#";
  a.target = "_blank";
  a.rel = "noopener";
  a.textContent = "Journal page";
  footer.appendChild(a);
  main.appendChild(footer);

  // Right tags
  const tags = el("div", "paper-tags");

  const grp = groupFromByline(p.byline);
  if(grp){
    tags.appendChild(el("span", "tag", grp));
  }

  const kws = Array.isArray(p.keywords) ? p.keywords : [];
  kws.forEach((k, idx) => {
    tags.appendChild(el("span", "tag " + classifyTag(k, idx), k));
  });

  const yr = yearFromDate(p.publishedDate);
  if(yr){
    tags.appendChild(el("span", "tag year", yr));
  }

  card.appendChild(main);
  card.appendChild(tags);
  return card;
}

function renderLogItem(item, isLatest){
  const li = el("li", "log-item" + (isLatest ? " latest" : ""));
  const d = el("div", "log-date", item.date || "");
  d.dataset.rawDate = item.date || "";
  li.appendChild(d);
  li.appendChild(el("div", "log-text", item.text || ""));
  return li;
}

function resolveTodayLabels(){
  const nodes = document.querySelectorAll(".log-date");
  const now = new Date();
  const todayISO =
    now.getFullYear() + "-" +
    String(now.getMonth()+1).padStart(2,"0") + "-" +
    String(now.getDate()).padStart(2,"0");

  nodes.forEach(n => {
    const raw = (n.dataset.rawDate || n.textContent || "").trim();
    if(raw.toLowerCase() === "today") n.textContent = todayISO;
  });
}

async function load(){
  const titleEl = document.getElementById("page-title");
  const subtitleEl = document.getElementById("page-subtitle");
  const listEl = document.getElementById("paper-list");
  const logEl = document.getElementById("log-list");

  try{
    const res = await fetch("journal.json", { cache: "no-store" });
    if(!res.ok) throw new Error(`Failed to fetch journal.json (HTTP ${res.status})`);
    const data = await res.json();

    document.title = data.title || "Journal";
    titleEl.textContent = data.title || "Journal";
    subtitleEl.textContent = data.intro || "";

    applySeededGradient(data.title || "Journal");

    listEl.innerHTML = "";
    (data.entries || []).forEach(p => listEl.appendChild(renderPaperCard(p)));

    logEl.innerHTML = "";
    (data.updateLog || []).forEach((u, idx) => logEl.appendChild(renderLogItem(u, idx === 0)));

    resolveTodayLabels();

  } catch(err){
    titleEl.textContent = "β-Ga₂O₃ Journal Notes";
    subtitleEl.textContent = "Could not load journal content.";

    const box = document.createElement("div");
    box.className = "sidebar-card";
    box.innerHTML = `<h2>Error</h2><p class="log-help">${String(err && err.message ? err.message : err)}</p>`;
    logEl.innerHTML = "";
    listEl.innerHTML = "";
    listEl.appendChild(box);
  }
}

document.addEventListener("DOMContentLoaded", load);
</script>

</body>
</html>
